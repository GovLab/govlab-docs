<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Circle CI</title>

    <link rel="stylesheet" href="https://govlab.github.io/govlab-docs/vendor/foundation.min.css">
    <link rel="stylesheet" href="https://govlab.github.io/govlab-docs/vendor/styleguide-v2.css">
    <link rel="stylesheet" href="https://govlab.github.io/govlab-docs/vendor/prism.css">
    <link rel="stylesheet" href="https://govlab.github.io/govlab-docs/vendor/slick.css"/>
    <link rel="stylesheet" href="https://govlab.github.io/govlab-docs/css/styles.css">
    <script src="https://use.typekit.net/mvc3cdb.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body class="">

    
<main role="main" class="main-wrapper"> <!-- main content starts here -->
<aside class="sidebar">
<h1 class="main-logo">
  <img src="https://govlab.github.io/govlab-docs/images/govlab-logo-white.png" alt="">
  Docs
</h1>

<section class="sidebar-list">
<ul class="animate">

  <li><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#introduction">Introduction</a>
    
      <ul class="animate">
        
          <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#basic-tech-stack">Basic Tech Stack</a>
          
            <ul class="animate">
              
                <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#jekyll">Jekyll</a>
                
                  <ul class="animate">
                  
                    <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#layouts">Layouts</a>
                  
                    <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#data">Data</a>
                  
                    <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#posts">Posts</a>
                  
                  </ul>
                
              
                <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#gulp">Gulp</a>
                
              
            </ul>
          
        
          <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#styleguide">Styleguide</a>
          
        
          <li class="animate"><a class="js-trigger" href="https://govlab.github.io/govlab-docs/#colors">Colors</a>
          
        
      </ul>
    

</ul>
<!-- Projects menu -->
<ul class="animate">
  <li><a class="js-trigger" href="#projects">Projects</a>
      <ul class="animate">
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/data-collaboratives.html">Data Collaboratives</a>
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/network-of-innovators.html">Network of Innovators</a>
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/od500.html">OD500</a>
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/open-data-impact-case-studies.html">Open Data Impact Case Studies</a>
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/opening-governance.html">Opening Governance</a>
        
        
          <li class="animate"><a class="js-trigger" href="/govlab-docs/projects/smarter-crowdsourcing.html">Smarter Crowdsourcing</a>
        
      </ul>
  </ul>

  <!-- Tools menu -->
  <ul class="animate">
    <li><a class="js-trigger" href="#tools">Tools</a>
        <ul class="animate">
          
          
            <li class="animate"><a class="js-trigger" href="/govlab-docs/tools/circle-ci.html">Circle CI</a>
          
          
            <li class="animate"><a class="js-trigger" href="/govlab-docs/tools/contentful.html">Contentful</a>
          
          
            <li class="animate"><a class="js-trigger" href="/govlab-docs/tools/jekyll.html">Jekyll</a>
          
        </ul>
    </ul>

</section>

</aside>

<section class="main-content long-text docs :.tech-docs-page">
  <h1 class="page-title">Circle CI</h1>
  <h3 id="automated-builds-with-circleci-contentful-and-gulp">Automated Builds with CircleCI, Contentful, and Gulp</h3>

<p>Based on <a href="https://www.contentful.com/developers/docs/ruby/tutorials/automated-rebuild-and-deploy-with-circleci-and-webhooks/">Automated rebuild and deploy with CircleCI and Webhooks</a></p>

<p><strong>1. Add an SSH key:</strong></p>
<ul>
  <li><a href="https://help.github.com/articles/adding-a-new-ssh-key-to-your-github-account/">Github Instructions</a></li>
  <li><a href="https://circleci.com/docs/1.0/adding-read-write-deployment-key/">Circle CI Instructions</a></li>
</ul>

<p><strong>2. Add your project to <a href="https://circleci.com/">CircleCI</a>:</strong>
When you log in with your GitHub account, your organizations and their projects will be listed in CircleCI. Select your organization, and click on Add Project.</p>

<p><img src="/govlab-docs/images/circleci/0a-circleci-add-project.png" alt="" /></p>

<p><strong>3. Setup Project</strong></p>

<p>Select the project you want to start building and click on Setup Project.</p>

<p><img src="/govlab-docs/images/circleci/0b-circle-ci-setup-project.png" alt="" /></p>

<p>This will take you to the setup page. Select Linux as the operating system and Ruby as the language.</p>

<p><img src="/govlab-docs/images/circleci/0c-circleci-setup-page.png" alt="" /></p>

<p>You can ignore Next Steps because we will provide a custom circle.yml file. Click on Start Building.</p>

<p><img src="/govlab-docs/images/circleci/0d-circleci-startbuilding.png" alt="" /></p>

<p>Cancel the build on the next page.</p>

<p><img src="/govlab-docs/images/circleci/0e-circleci-build-page.png" alt="" /></p>

<p>A CircleCI deploy key added to your GitHub project in <strong>Settings –&gt; Deploy Keys</strong></p>

<p><strong>4. Generate your CircleCI API Token in Accounts/Personal API token.</strong>
You can find the token in User Settings/Personal API Tokens.</p>

<p><img src="/govlab-docs/images/circleci/1-circle-ci-personal-api-token.png" alt="" /></p>

<p><strong>5. Log into Contentful and create your webhook in your project space.</strong></p>

<p><img src="/govlab-docs/images/circleci/2-contentful-setting-webhooks.png" alt="" /></p>

<p>Add the following URL to the web hook settings page</p>

<div class="highlighter-rouge"><pre class="highlight"><code>https://circleci.com/api/v1/project/YOUR_COMPANY/YOUR_PROJECT/tree/master?circle-token=YOUR_CIRCLECI_TOKEN
</code></pre>
</div>
<p><img src="/govlab-docs/images/circleci/4-contentful-webhook-url.png" alt="" /></p>

<!-- ![](/govlab-docs/images/circleci/3-contentful-webhook-list.png) -->

<p>Trigger webhooks for ‘Only selected events’ and on Publish/Unpublish.</p>

<p><img src="/govlab-docs/images/circleci/5-contentful-webhook-settings.png" alt="" />
<!-- ![](/govlab-docs/images/circleci/6-circle-ci-project-settings.png) --></p>

<p><strong>6. Add your deploy key and user key</strong></p>

<p>Builds —&gt; Project Settings &gt; Permissions &gt; Checkout SSH Keys.</p>

<p><img src="/govlab-docs/images/circleci/8-circleci-user-keys.png" alt="" /></p>

<p><strong>7. Add automated_build.sh</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>
<span class="c"># Copy static site</span>
<span class="nv">CWD</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>

<span class="c"># Clone Pages repository</span>
<span class="nb">cd</span> /tmp
git clone git@github.com:organization/project-name.git build
<span class="nb">cd </span>build <span class="o">&amp;&amp;</span> git checkout -b gh-pages origin/gh-pages
<span class="c"># cd build &amp;&amp; git checkout -b YOUR_BRANCH origin/YOUR_BRANCH # If not using master</span>

<span class="c"># Trigger Jekyll rebuild</span>
<span class="nb">cd</span> <span class="nv">$CWD</span>
bundle <span class="nb">exec </span>jekyll contentful
bundle <span class="nb">exec </span>jekyll build

<span class="c"># Push newly built repository</span>
cp -r <span class="nv">$CWD</span>/_site/<span class="k">*</span> /tmp/build  <span class="c">#or $CWD/_site</span>

<span class="nb">cd</span> /tmp/build

git config --global user.email <span class="nv">$GH_EMAIL</span>
git config --global user.name <span class="nv">$GH_USERNAME</span>

git add .
git commit -m <span class="s2">"Automated Rebuild"</span>

</code></pre>
</div>

<p>Edit the repo url and git configs in the automated_build.sh script</p>

<ul>
  <li>
    <p>Replace repo here</p>

    <p><img src="/govlab-docs/images/circleci/9-replace-repo-url.png" alt="" /></p>
  </li>
  <li>
    <p>Replace git config here
<img src="/govlab-docs/images/circleci/10-replace-git-config.png" alt="" /></p>
  </li>
</ul>

<p><strong>8. Add circle.yml config file</strong></p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code>
<span class="s">machine</span><span class="pi">:</span>
  <span class="s">environment</span><span class="pi">:</span>
    <span class="s">NOKOGIRI_USE_SYSTEM_LIBRARIES</span><span class="pi">:</span> <span class="s">true</span> <span class="c1"># speeds up installation of html-proofer</span>
  <span class="s">node</span><span class="pi">:</span>
    <span class="s">version</span><span class="pi">:</span> <span class="s">6.10.3</span>

<span class="s">general</span><span class="pi">:</span>
  <span class="s">branches</span><span class="pi">:</span>
    <span class="s">only</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">master</span> <span class="c1"># list of branches to build</span>

<span class="s">dependencies</span><span class="pi">:</span>
  <span class="s">pre</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">gem install bundler</span>

<span class="s">checkout</span><span class="pi">:</span>
  <span class="s">post</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">bundle install</span>
    <span class="pi">-</span> <span class="s">bash automated_build.sh</span>

<span class="s">deployment</span><span class="pi">:</span>
  <span class="s">prod</span><span class="pi">:</span>
    <span class="s">branch</span><span class="pi">:</span> <span class="s">master</span>
    <span class="s">commands</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">gulp deploy</span>

</code></pre>
</div>

<p>We’re only running builds on changes pushed to master, so the circle.yml file needs to be piped into the _site folder in order for CircleCI to read it. In the gulpfile, add this task:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'circleci'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">'./circle.yml'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'_site'</span><span class="p">));</span>
<span class="p">});</span>

</code></pre>
</div>
<p>And add to the deploy task.</p>

<p><strong>9. Add ENV variables to CircleCI</strong></p>

<p>Instructions <a href="https://circleci.com/blog/new-on-circleci-import-project-environment-variables/">here</a>.</p>


</section>

</main>



    <div id="overlay" class="js-overlay"></div>
    <script src="https://govlab.github.io/govlab-docs/vendor/jquery-2.1.4.min.js"></script>
    <script src="https://govlab.github.io/govlab-docs/vendor/slick.min.js"></script>
    <script src="https://govlab.github.io/govlab-docs/vendor/prism.js"></script>
    <script src="https://govlab.github.io/govlab-docs/js/scripts.js"></script>
</body>
</html>
